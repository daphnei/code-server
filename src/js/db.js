// Generated by CoffeeScript 1.7.1
(function() {
  var Q, connection, createQuestionOrUpdateScore, doesQuestionExist, getNextQuestionId, mysql;

  mysql = require('mysql');

  Q = require('q');

  connection = mysql.createConnection({
    host: 'sql3.freemysqlhosting.net',
    user: 'sql330935',
    password: 'fW2!cZ8%',
    database: 'sql330935'
  });

  exports.connectAndQuery = function(query, queryArgs) {
    var data;
    if (queryArgs == null) {
      queryArgs = [];
    }
    data = Q.defer();
    connection.query(query, queryArgs, function(err, rows, fields) {
      if (err) {
        return data.reject(err);
      } else {
        return data.resolve(rows);
      }
    });
    return data.promise;
  };

  exports.getMostDifficultQuestions = function(limit) {
    var queryString;
    queryString = "SELECT * FROM questions WHERE num_answers >= 5 ORDER BY average_score LIMIT ?";
    return exports.connectAndQuery(queryString, [limit]);
  };

  exports.getQuestions = function(type, limit) {
    var queryString, tableName;
    tableName = mysql.escapeId(type + '_questions');
    queryString = "SELECT * FROM questions INNER JOIN " + tableName + " ON " + tableName + ".qid = questions.id LIMIT ?";
    return exports.connectAndQuery(queryString, [limit]);
  };

  getNextQuestionId = function() {
    var nextId;
    nextId = Q.defer();
    exports.connectAndQuery('SELECT COUNT(*) FROM questions').then(function(data) {
      return nextId.resolve(data['COUNT(*)']);
    });
    return nextId.promise;
  };

  doesQuestionExist = function(type, food1, food2) {
    var weExist;
    weExist = q.defer();
    exports.connectAndQuery('SELECT COUNT(*) FROM questions WHERE type = ? AND food1 = ? AND food2 = ?', [type, food1, food2], function(data) {
      return weExist.resolve(parseInt(data["COUNT(*)"]) === 0);
    });
    return weExist.promise;
  };

  createQuestionOrUpdateScore = function(type, food1, food2, score) {
    return doesQuestionExist(type, food1, food2).then(function(exists) {
      if (exists) {
        return {};
      }
    });
  };

}).call(this);
